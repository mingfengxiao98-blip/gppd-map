<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>全球电厂能源结构与装机规模（WRI GPPD）</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- PapaParse (CSV parser) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif; }
    #map { height: 100%; width: 100%; }

    .panel {
      position: absolute; top: 12px; left: 12px; z-index: 1000;
      width: min(360px, calc(100vw - 24px));
      background: rgba(255,255,255,0.95);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      padding: 12px 12px 10px 12px;
      backdrop-filter: blur(6px);
    }
    .panel h1 { font-size: 16px; margin: 0 0 6px 0; }
    .panel .sub { font-size: 12px; color: #444; line-height: 1.35; }
    .row { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
    .row label { font-size: 12px; color: #222; }
    .row input[type="range"] { width: 100%; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .chip {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.9);
      font-size: 12px; cursor: pointer; user-select: none;
    }
    .chip input { margin: 0; }
    .legend {
      margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 6px 10px;
      font-size: 12px; color: #222;
    }
    .lg-item { display: flex; align-items: center; gap: 8px; }
    .sw { width: 10px; height: 10px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.25); }
    .footer {
      margin-top: 10px; font-size: 11px; color: #555; line-height: 1.35;
    }
    .status {
      margin-top: 8px; font-size: 12px; color: #111;
      display: flex; justify-content: space-between; align-items: center;
      gap: 10px;
    }
    .bar { flex: 1; height: 6px; border-radius: 999px; background: rgba(0,0,0,0.08); overflow: hidden; }
    .bar > div { height: 100%; width: 0%; background: rgba(0,0,0,0.6); transition: width 0.2s ease; }
    .btn {
      margin-top: 10px;
      display: inline-flex; align-items: center; justify-content: center;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.95);
      cursor: pointer;
      font-size: 12px;
    }
    .btn:hover { background: #fff; }

    /* Mobile: move panel to bottom if needed */
    @media (max-width: 520px) {
      .panel { top: auto; bottom: 12px; left: 12px; }
    }
  </style>
</head>

<body>
<div id="map"></div>

<div class="panel" id="panel">
  <h1>全球电厂能源结构与装机规模</h1>
  <div class="sub">
    数据：WRI Global Power Plant Database（GPPD, v1.3.0，CSV）。颜色=燃料类型，点大小=装机容量（MW）。拖动筛选容量，勾选筛选燃料。
  </div>

  <div class="row">
    <label style="min-width: 88px;">最小容量</label>
    <input id="capRange" type="range" min="0" max="2000" step="50" value="0"/>
  </div>
  <div class="row" style="margin-top:6px;">
    <div style="font-size:12px;color:#222;">≥ <span id="capVal">0</span> MW</div>
    <div style="flex:1"></div>
    <div style="font-size:12px;color:#444;"><span id="shownCount">0</span> / <span id="totalCount">0</span></div>
  </div>

  <div class="chips" id="fuelChips"></div>

  <div class="legend" id="legend"></div>

  <div class="status">
    <span id="statusText">准备加载数据…</span>
    <div class="bar"><div id="barFill"></div></div>
  </div>

  <div class="btn" id="resetBtn">重置视图</div>

  <div class="footer">
    © OpenStreetMap contributors（底图） · 数据许可：CC BY 4.0（WRI GPPD）。<br/>
    说明：本页面会从 WRI 的公开 CSV 链接按需加载数据（首次加载可能稍慢）。
  </div>
</div>

<script>
  // === 1) Basic map ===
  const map = L.map('map', { zoomControl: true }).setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const cluster = L.markerClusterGroup({
    chunkedLoading: true,
    chunkProgress: updateProgress
  });
  map.addLayer(cluster);

  // === 2) Data source (public raw CSV) ===
  // Source known public URL used widely for teaching / tooling:
  const CSV_URL = 'https://cdn.jsdelivr.net/gh/wri/global-power-plant-database@master/output_database/global_power_plant_database.csv';

  // === 3) Styling ===
  const fuelColors = {
    Coal: "#4b5563",
    Gas: "#2563eb",
    Oil: "#a16207",
    Hydro: "#0ea5e9",
    Wind: "#22c55e",
    Solar: "#f59e0b",
    Nuclear: "#7c3aed",
    Biomass: "#16a34a",
    Geothermal: "#ef4444",
    Waste: "#f97316",
    Other: "#64748b"
  };

  const fuelOrder = Object.keys(fuelColors);

  function radiusFromCapacity(cap) {
    // Gentle scale: cap (MW) -> radius
    if (!isFinite(cap) || cap <= 0) return 4;
    if (cap < 100) return 4;
    if (cap < 500) return 6;
    if (cap < 2000) return 9;
    return 12;
  }

  function colorForFuel(fuel) {
    return fuelColors[fuel] || fuelColors.Other;
  }

  // === 4) UI state ===
  const state = {
    minCap: 0,
    fuels: new Set(fuelOrder), // selected fuels
    rows: [],
    markers: [] // { marker, fuel, cap }
  };

  // Build chips + legend
  const chipsEl = document.getElementById('fuelChips');
  const legendEl = document.getElementById('legend');

  function buildFuelUI() {
    chipsEl.innerHTML = '';
    legendEl.innerHTML = '';

    fuelOrder.forEach(f => {
      // chips
      const chip = document.createElement('label');
      chip.className = 'chip';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = true;
      cb.dataset.fuel = f;
      cb.addEventListener('change', (e) => {
        const fuel = e.target.dataset.fuel;
        if (e.target.checked) state.fuels.add(fuel);
        else state.fuels.delete(fuel);
        applyFilters();
      });
      const sw = document.createElement('span');
      sw.className = 'sw';
      sw.style.background = colorForFuel(f);

      const txt = document.createElement('span');
      txt.textContent = f;

      chip.appendChild(cb);
      chip.appendChild(sw);
      chip.appendChild(txt);
      chipsEl.appendChild(chip);

      // legend
      const item = document.createElement('div');
      item.className = 'lg-item';
      const sw2 = document.createElement('span');
      sw2.className = 'sw';
      sw2.style.background = colorForFuel(f);
      const lb = document.createElement('span');
      lb.textContent = f;
      item.appendChild(sw2);
      item.appendChild(lb);
      legendEl.appendChild(item);
    });
  }
  buildFuelUI();

  // Capacity slider
  const capRange = document.getElementById('capRange');
  const capVal = document.getElementById('capVal');
  capRange.addEventListener('input', () => {
    state.minCap = Number(capRange.value || 0);
    capVal.textContent = state.minCap;
    applyFilters();
  });

  // Reset button
  document.getElementById('resetBtn').addEventListener('click', () => {
    map.setView([20, 0], 2);
  });

  // Status/progress
  const statusText = document.getElementById('statusText');
  const barFill = document.getElementById('barFill');

  function setStatus(text) { statusText.textContent = text; }
  function setBar(pct) { barFill.style.width = Math.max(0, Math.min(100, pct)) + '%'; }

  function updateProgress(processed, total, elapsed) {
    // called by marker cluster when chunked loading
    const pct = total ? (processed / total) * 100 : 0;
    setBar(pct);
    setStatus(`正在渲染点位：${processed.toLocaleString()} / ${total.toLocaleString()}`);
  }

  function updateCounts(shown, total) {
    document.getElementById('shownCount').textContent = shown.toLocaleString();
    document.getElementById('totalCount').textContent = total.toLocaleString();
  }

  // === 5) Build markers ===
  function makeMarker(row) {
    const lat = Number(row.latitude);
    const lon = Number(row.longitude);
    if (!isFinite(lat) || !isFinite(lon)) return null;

    const fuel = row.primary_fuel || 'Other';
    const cap = Number(row.capacity_mw);

    const r = radiusFromCapacity(cap);
    const color = colorForFuel(fuel);

    const marker = L.circleMarker([lat, lon], {
      radius: r,
      color: color,
      weight: 1,
      fillColor: color,
      fillOpacity: 0.75
    });

    const name = row.name || '(unknown)';
    const country = row.country_long || row.country || '';
    const owner = row.owner || '';
    const year = row.commissioning_year || '';
    const url = row.url || '';

    const html = `
      <div style="min-width:240px">
        <div style="font-weight:700;font-size:14px;line-height:1.25;">${escapeHtml(name)}</div>
        <div style="margin-top:6px;font-size:12px;color:#333;line-height:1.35;">
          <b>国家：</b>${escapeHtml(country)}<br/>
          <b>燃料：</b>${escapeHtml(fuel)}<br/>
          <b>容量：</b>${isFinite(cap) ? cap.toFixed(1) : 'NA'} MW<br/>
          ${owner ? `<b>业主：</b>${escapeHtml(owner)}<br/>` : ``}
          ${year ? `<b>投运年：</b>${escapeHtml(String(year))}<br/>` : ``}
          ${url ? `<b>来源：</b><a href="${escapeAttr(url)}" target="_blank" rel="noopener">link</a>` : ``}
        </div>
      </div>
    `;
    marker.bindPopup(html);
    return { marker, fuel, cap };
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s) {
    return String(s).replace(/"/g, '&quot;');
  }

  // === 6) Filtering ===
  function applyFilters() {
    // Quick rebuild: clear cluster then add back matching markers.
    cluster.clearLayers();
    let shown = 0;
    for (const item of state.markers) {
      const okFuel = state.fuels.has(item.fuel);
      const okCap = !isFinite(item.cap) ? (state.minCap === 0) : (item.cap >= state.minCap);
      if (okFuel && okCap) {
        cluster.addLayer(item.marker);
        shown += 1;
      }
    }
    updateCounts(shown, state.markers.length);
    setStatus(`已筛选显示：${shown.toLocaleString()} 个点`);
    setBar(100);
  }

  // === 7) Load CSV ===
  function loadData() {
    setStatus('正在下载并解析 CSV…');
    setBar(5);

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      dynamicTyping: false,
      worker: true,
      skipEmptyLines: true,
      step: function() { /* stream steps handled internally */ },
      complete: function(results) {
        const rows = results.data || [];
        state.rows = rows;
        setStatus(`解析完成：${rows.length.toLocaleString()} 条记录，正在构建点位…`);
        setBar(20);

        const markers = [];
        // Build markers (can take time)
        const total = rows.length;
        let i = 0;
        const chunk = 1500;

        function buildChunk() {
          const end = Math.min(i + chunk, total);
          for (; i < end; i++) {
            const m = makeMarker(rows[i]);
            if (m) markers.push(m);
          }
          const pct = 20 + (i / total) * 60; // 20% -> 80%
          setBar(pct);
          setStatus(`构建点位：${i.toLocaleString()} / ${total.toLocaleString()}`);

          if (i < total) {
            setTimeout(buildChunk, 0);
          } else {
            state.markers = markers;
            updateCounts(markers.length, markers.length);
            setStatus(`构建完成：${markers.length.toLocaleString()} 个有效点位，正在渲染聚合…`);
            setBar(85);

            // Add all, then filters will re-add subset quickly
            cluster.addLayers(markers.map(d => d.marker));
            setTimeout(() => {
              applyFilters();
            }, 0);
          }
        }
        buildChunk();
      },
      error: function(err) {
        console.error(err);
        setStatus('加载失败：请检查网络是否可访问 GitHub Raw（raw.githubusercontent.com）。');
        setBar(0);
      }
    });
  }

  loadData();
</script>
</body>
</html>
